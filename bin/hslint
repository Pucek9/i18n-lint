#!/usr/bin/env node
'use strict';

// NPM dependencies
var glob = require('glob');
var hslint = require('../lib/hslint');
var program  = require('commander');

// Local variables
var completed = 0;
var failed = false;
var options = {};
var pkg = require('../package.json');
var reporter;

// Helper functions
var done = function() {
  if (failed) {
    process.exit(1);
  } else {
    process.exit(0);
  }
};

program.on('--help', function() {
  process.stdout.write('  Use `man hslint` for more information\n\n');
});

program
  .version(pkg.version)
  .option(
    '-a, --attributes <attributes>',
    'Comma-separated list of HTML attributes to lint (default: \'alt,title\')',
    function(raw) {
      return raw.split(',');
    }
  )
  .option(
    '-i, --ignore-tags <tags>',
    'Comma-separated list of names of tags to ignore whilst linting '+
        '(default: \'script,style\')',
    function(raw) {
      return raw.split(',');
    }
  )
  .option(
    '-t, --template-delimiters <delimiters>',
    'Template delimiters used in source files.  For example, Mustache-like ' +
        'templating languages should use \'{{,}}\'',
    function(raw) {
      return raw.split(',');
    }
  )
  .option(
    '-r, --reporter <reporter>',
    'Specify which reporter to output results with'
  )
  .option(
    '--color', 'Force colored output'
  )
  .option(
    '--no-color', 'Disable colored output'
  )
  .usage('[OPTIONS] <file ...>')
  .parse(process.argv)
;

if (program.args.length < 1 ) {
	console.log('No files specified. See \'hslint --help\':');
	program.outputHelp();
	process.exit(64);
}

program.options.forEach(function(option) {
  var key = option.long.replace(/^--/, '')
      .replace(/-([a-z])/g, function(orig, match) {
        return match.toUpperCase();
      });

  options[key] = program[key];
});

if (options.reporter) {

  // Check built-in hslint reporters first
  reporter = hslint.reporters[options.reporter];

  if (!reporter) {
    try {
      reporter = require(options.reporter).reporter;
    } catch(e) {
      process.stderr.write('No reporter called \'' + options.reporter + '\'\n');
      process.exit(66);
    }
  }
} else {
  reporter = hslint.reporters.default;
}

delete options.reporter;

program.args.forEach(function(src) {
  glob(src, function(err, files) {
    if (err) {
      process.stderr.write(err);
      process.exit(70);
    }

    files.forEach(function(file) {
      var errors = hslint(file, options);
      reporter(errors);

      if (errors.length) {
        failed = true;
      }
    });

    completed++;

    if (completed === program.args.length) {
      done();
    }
  });
});
